<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <title>Mathletics - Ultra Neon RGB Edition</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&family=Fredoka+One&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #6c5ce7;
      --deep-purple: #1e1b4b;
      --neon-purple: #a29bfe;
      --neon-green: #00ff88;
      --neon-orange: #ff9f43;
      --danger: #ff4757;
      --card-bg: rgba(30, 27, 75, 0.85);
      --white: #ffffff;
    }

    body {
      font-family: 'Kanit', sans-serif;
      margin: 0; 
      background: #0f172a;
      background-image: 
        linear-gradient(rgba(108, 92, 231, 0.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(108, 92, 231, 0.1) 1px, transparent 1px);
      background-size: 40px 40px;
      display: flex; align-items: center; justify-content: center;
      height: 100vh; overflow: hidden; touch-action: manipulation;
    }

    @keyframes rgbGlow {
      0% { border-color: #ff0000; box-shadow: 0 0 20px #ff0000; }
      20% { border-color: #00ff00; box-shadow: 0 0 25px #00ff00; }
      40% { border-color: #00ffff; box-shadow: 0 0 20px #00ffff; }
      60% { border-color: #0000ff; box-shadow: 0 0 25px #0000ff; }
      80% { border-color: #ff00ff; box-shadow: 0 0 20px #ff00ff; }
      100% { border-color: #ffff00; box-shadow: 0 0 25px #ffff00; }
    }

    .streak-aura-rgb { 
      animation: rgbGlow 2s linear infinite !important; 
      border-width: 3px !important;
    }

    body::before {
      content: ''; position: absolute; width: 300px; height: 300px;
      background: var(--primary); filter: blur(150px);
      border-radius: 50%; top: -100px; left: -100px; opacity: 0.3; z-index: -1;
    }

    #fireworksCanvas {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; z-index: 999;
    }

    .logo-text {
      font-family: 'Fredoka One', cursive;
      font-size: 3.5rem; letter-spacing: 2px;
      margin-bottom: 5px; display: inline-block;
      color: var(--white);
      text-shadow: 0 0 10px var(--neon-purple), 0 0 20px var(--primary);
    }
    .logo-text span { color: var(--neon-green); }

    #music-control {
      position: fixed; top: 20px; right: 20px; z-index: 1000;
      background: rgba(255, 255, 255, 0.1); border: 1px solid var(--neon-purple);
      width: 48px; height: 48px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; color: white;
      backdrop-filter: blur(5px);
      box-shadow: 0 0 15px rgba(108, 92, 231, 0.3);
      transition: 0.3s;
    }

    .game-hud { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; width: 100%; max-width: 480px; }
    .hearts-ui { color: var(--danger); font-size: 1.2rem; text-shadow: 0 0 10px var(--danger); }
    .items-ui { display: flex; gap: 5px; }
    .item-btn { 
      background: rgba(255,255,255,0.1); border: 1px solid var(--neon-purple); 
      color: white; padding: 4px 8px; border-radius: 8px; font-size: 0.7rem; cursor: pointer;
    }
    .item-btn:disabled { opacity: 0.3; cursor: default; }

    .screen {
      position: absolute; width: 100%; max-width: 480px;
      padding: 20px; box-sizing: border-box; text-align: center;
      transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .hidden { display: none !important; opacity: 0; transform: scale(0.9) translateY(20px); }

    .card {
      background: var(--card-bg); padding: 40px 30px;
      border-radius: 40px; 
      backdrop-filter: blur(10px);
      border: 2px solid rgba(162, 155, 254, 0.2);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
      position: relative; z-index: 10;
    }

    button {
      background: linear-gradient(135deg, var(--primary), var(--neon-purple));
      color: white; border: none;
      padding: 16px 25px; border-radius: 18px; font-size: 1.15rem;
      font-weight: 600; cursor: pointer; transition: 0.2s;
      box-shadow: 0 5px 15px rgba(108, 92, 231, 0.4);
      width: 100%; font-family: 'Kanit';
      margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1);
    }
    button.secondary { background: #475569; }
    button.rank-btn { background: linear-gradient(135deg, #f59e0b, #fbbf24); color: #451a03; }
    button.share-btn { background: linear-gradient(135deg, #00d2ff, #3a7bd5); margin-top: 10px; }

    input[type="text"] {
      width: 100%; padding: 15px; font-size: 3rem;
      border: 3px solid rgba(162, 155, 254, 0.3); border-radius: 20px;
      text-align: center; color: var(--neon-green); font-weight: 600;
      background: rgba(0,0,0,0.4); outline: none; box-sizing: border-box;
      font-family: 'Fredoka One'; text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
    }

    .timer-bar { width: 100%; height: 12px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; margin-bottom: 20px; position: relative;}
    #timer-fill { height: 100%; background: linear-gradient(90deg, var(--neon-green), var(--neon-purple)); width: 100%; }
    
    /* --- [‡πÉ‡∏´‡∏°‡πà] Ghost Mode UI --- */
    #ghost-marker {
      position: absolute; top: 0; width: 3px; height: 100%;
      background: white; box-shadow: 0 0 8px white;
      display: none; transition: left 0.3s;
    }

    .timer-danger { background: var(--danger) !important; animation: blink 0.5s infinite; }
    @keyframes blink { 50% { opacity: 0.5; } }

    .rank-table { width: 100%; margin-top: 15px; border-collapse: separate; border-spacing: 0 8px; }
    .rank-table tr { background: rgba(255,255,255,0.05); }
    .rank-table td { padding: 15px; color: white; }

    #badge-ui { display: inline-block; background: var(--neon-orange); color: black; padding: 4px 12px; border-radius: 8px; font-weight: bold; margin-bottom: 10px; font-size: 0.9rem; }

    /* --- [‡πÉ‡∏´‡∏°‡πà] Global Rank UI --- */
    .global-percent {
      font-size: 0.9rem; color: var(--neon-green);
      background: rgba(0, 255, 136, 0.1);
      padding: 5px 15px; border-radius: 20px;
      display: inline-block; margin-bottom: 15px;
      border: 1px solid rgba(0, 255, 136, 0.3);
    }

    @keyframes shake {
      0%, 100% { transform: translate(0, 0); }
      25% { transform: translate(-8px, 0); }
      75% { transform: translate(8px, 0); }
    }
    .shake { animation: shake 0.3s; }
  </style>
</head>
<body id="mainBody">

  <canvas id="fireworksCanvas"></canvas>
  <div id="music-control" onclick="toggleMusic()">üîä</div>

  <div id="intro" class="screen">
    <div class="card">
      <div class="logo-text">MATH<span>LETICS</span></div>
      <p style="color: #94a3b8; margin-top:0;">‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏û‡∏•‡∏±‡∏á‡∏™‡∏°‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
      <button onclick="initAudio(); changeScreen('mathTips1')">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á üöÄ</button>
      <button class="rank-btn" onclick="viewRanks()">üèÜ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏ù‡∏µ‡∏°‡∏∑‡∏≠</button>
    </div>
  </div>

  <div id="rankView" class="screen hidden">
    <div class="card">
      <h2 style="color:var(--neon-purple); margin-top:0;">HALL OF FAME</h2>
      <table class="rank-table" id="viewRankTable"></table>
      <div style="margin-top: 25px;">
        <button class="secondary" onclick="changeScreen('intro')">üîô ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
      </div>
    </div>
  </div>

  <div id="mathTips1" class="screen hidden">
    <div class="card">
      <h2 style="color:var(--neon-green)">üìñ ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</h2>
      <div style="text-align: left; background: rgba(0,0,0,0.3); padding: 20px; border-radius: 20px; margin-bottom: 20px; color: #cbd5e1; font-size: 0.9rem;">
        ‚Ä¢ <b>Hearts:</b> ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏´‡∏±‡∏ß‡πÉ‡∏à 3 ‡∏î‡∏ß‡∏á ‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢ 1 ‡∏î‡∏ß‡∏á<br>
        ‚Ä¢ <b>Items:</b> ‡πÉ‡∏ä‡πâ Slow ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ x2 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏π‡∏ì‡∏™‡∏≠‡∏á<br>
        ‚Ä¢ <b>RGB Streak:</b> ‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å 5 ‡∏Ç‡πâ‡∏≠‡∏£‡∏ß‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏ü‡∏™‡∏µ‡∏£‡∏∏‡πâ‡∏á!<br>
        ‚Ä¢ <b>Ghost:</b> ‡πÅ‡∏Ç‡πà‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÄ‡∏™‡πâ‡∏ô‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß)
      </div>
      <div style="display:flex; gap:10px;">
        <button class="secondary" onclick="changeScreen('intro')">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        <button onclick="changeScreen('mathGuide')">‡∏ï‡πà‡∏≠‡πÑ‡∏õ ‚û°Ô∏è</button>
      </div>
    </div>
  </div>

  <div id="mathGuide" class="screen hidden">
    <div class="card">
      <h2 style="color:var(--neon-orange)">üí° ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡πÄ‡∏ß‡∏•</h2>
      <div style="text-align: left; background: rgba(0,0,0,0.3); padding: 20px; border-radius: 20px; margin-bottom: 20px; color: #cbd5e1;">
        <b style="color:var(--neon-green)">Easy:</b> ‡∏ö‡∏ß‡∏Å-‡∏•‡∏ö‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô (‡∏´‡∏±‡∏ß‡πÉ‡∏à 3)<br><br>
        <b style="color:var(--neon-orange)">Medium:</b> ‡∏™‡∏°‡∏Å‡∏≤‡∏£ x ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏Ç‡∏ï‡∏¥‡∏î‡∏•‡∏ö (‡∏´‡∏±‡∏ß‡πÉ‡∏à 3)<br><br>
        <b style="color:var(--danger)">Hard:</b> ‡∏ï‡∏£‡∏µ‡πÇ‡∏Å‡∏ì ‡πÅ‡∏•‡∏∞ Log ‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á! (‡∏´‡∏±‡∏ß‡πÉ‡∏à 3)
      </div>
      <div style="display:flex; gap:10px;">
        <button class="secondary" onclick="changeScreen('mathTips1')">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        <button onclick="changeScreen('mode')">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î üéÆ</button>
      </div>
    </div>
  </div>

  <div id="mode" class="screen hidden">
    <div class="card">
      <h2 style="color:var(--white)">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô</h2>
      <div style="display:flex; flex-direction:column; gap:10px;">
        <button onclick="startGame('easy')" style="background:var(--neon-green); color:#064e3b;">üü¢ ‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î (Easy)</button>
        <button onclick="startGame('medium')" style="background:var(--neon-orange); color:#431407;">üü° ‡∏ô‡∏±‡∏Å‡∏™‡∏π‡πâ (Medium)</button>
        <button onclick="startGame('hard')" style="background:var(--primary);">üî¥ ‡∏õ‡∏£‡∏°‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå (Hard)</button>
        <button class="secondary" onclick="changeScreen('mathGuide')">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
      </div>
    </div>
  </div>

  <div id="game" class="screen hidden">
    <div class="game-hud">
        <div class="hearts-ui" id="hearts-display">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        <div class="items-ui">
            <button class="item-btn" id="btn-slow" onclick="useSlow()">‚è≥ Slow (1)</button>
            <button class="item-btn" id="btn-double" onclick="useDouble()">‚≠ê x2 (1)</button>
        </div>
    </div>
    <div class="card" id="gameCard">
      <div class="timer-bar">
        <div id="timer-fill"></div>
        <div id="ghost-marker"></div>
      </div>
      <div style="display:flex; justify-content:space-between; font-weight:bold; color:var(--neon-purple); font-size: 0.85rem;">
        <span id="qNum">QUEST: 1/20</span>
        <span>‚≠ê SCORE: <span id="score">0</span></span>
      </div>
      <div id="questionText" style="font-size:3.5rem; font-weight:600; margin:20px 0; font-family: 'Fredoka One'; color: white;">?</div>
      <input type="text" id="answerInput" inputmode="numeric" placeholder="?" autocomplete="off">
      <div id="bonus-label" style="color: var(--neon-green); font-weight: bold; opacity: 0; font-size: 0.8rem;">SYSTEM CHARGED: BONUS!</div>
      <div id="comboBadge" class="combo-badge">COMBO x1.0</div>
      <button id="submitBtn" onclick="checkAnswer()" style="margin-top: 20px;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
    </div>
  </div>

  <div id="result" class="screen hidden">
    <div class="card">
      <div id="badge-ui">PRO CALCULATOR</div>
      <h1 id="congratsText" style="color:var(--neon-green); margin-top:0;">MISSION COMPLETE!</h1>
      
      <div class="global-percent" id="globalRankText">‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Å‡πà‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô 0% ‡∏Ç‡∏≠‡∏á‡πÇ‡∏•‡∏Å</div>
      
      <p style="color:#94a3b8;">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</p>
      <div id="finalScore" style="color:var(--white); font-size:4rem; font-weight:bold; font-family: 'Fredoka One'; margin-bottom: 20px;">0</div>
      
      <table class="rank-table" id="rankTable"></table>
      <div id="statsSummary" style="margin:20px 0; color:var(--neon-purple); font-weight:bold;"></div>
      
      <button class="share-btn" onclick="shareAchievement()">üì∏ ‡πÅ‡∏ä‡∏£‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</button>
      <button onclick="location.reload()" style="background:var(--primary);">üè† ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
    </div>
  </div>

  <script>
    let audioCtx, isMuted = false;
    let currentScore = 0, currentQ = 0, correctAns = 0, timer, difficulty = 'easy';
    let combo = 0, correctCount = 0, startTime, timeLimit = 12, lives = 3;
    let musicStep = 0, items = { slow: 1, double: 1 }, activeDouble = false, activeSlow = false;
    
    // Ghost Mode Data
    let bestTimes = JSON.parse(localStorage.getItem('mathBestTimes') || "{}");

    function initAudio() { if (audioCtx) return; audioCtx = new (window.AudioContext || window.webkitAudioContext)(); playFunMusic(); }
    
    function playFunMusic() {
      const scale = [261.63, 293.66, 329.63, 392.00, 440.00, 523.25];
      function playStep() {
        if (isMuted || !audioCtx) { setTimeout(playStep, 500); return; }
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
        let speed = Math.max(150, 400 - (combo * 20));
        let note = scale[musicStep % scale.length];
        if (combo > 5) note *= 2;
        osc.type = combo > 10 ? 'square' : 'triangle';
        osc.frequency.setValueAtTime(note, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.02, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.3);
        musicStep++; setTimeout(playStep, speed);
      }
      playStep();
    }

    function playSfx(freq, type='sine', duration=0.2) {
      if (isMuted || !audioCtx) return;
      const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
      osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
      gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.start(); osc.stop(audioCtx.currentTime + duration);
    }

    const canvas = document.getElementById('fireworksCanvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    class Particle {
      constructor(x, y, color) {
        this.x = x; this.y = y; this.color = color;
        this.velocity = { x: (Math.random() - 0.5) * 10, y: (Math.random() - 0.5) * 10 };
        this.alpha = 1; this.friction = 0.95;
      }
      draw() { ctx.globalAlpha = this.alpha; ctx.beginPath(); ctx.arc(this.x, this.y, 4, 0, Math.PI * 2); ctx.fillStyle = this.color; ctx.fill(); }
      update() { this.velocity.x *= this.friction; this.velocity.y *= this.friction; this.x += this.velocity.x; this.y += this.velocity.y; this.alpha -= 0.015; }
    }

    function createFirework() {
      const x = Math.random() * canvas.width; const y = Math.random() * (canvas.height * 0.5);
      const color = `hsl(${Math.random() * 360}, 100%, 50%)`;
      for (let i = 0; i < 40; i++) particles.push(new Particle(x, y, color));
      playSfx(200 + Math.random() * 400, 'sine', 0.5);
    }

    function animateFireworks() {
      if (document.getElementById('result').classList.contains('hidden')) return;
      requestAnimationFrame(animateFireworks);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      particles.forEach((p, i) => { if (p.alpha <= 0) particles.splice(i, 1); else { p.update(); p.draw(); } });
      if (Math.random() < 0.08) createFirework();
    }

    function toggleMusic() { isMuted = !isMuted; document.getElementById('music-control').textContent = isMuted ? '‚ùå' : 'üîä'; }
    function changeScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
    function viewRanks() { displayRank('viewRankTable'); changeScreen('rankView'); }

    function useSlow() { if(items.slow > 0) { items.slow--; activeSlow = true; updateHUD(); playSfx(300); } }
    function useDouble() { if(items.double > 0) { items.double--; activeDouble = true; updateHUD(); playSfx(800); } }
    function updateHUD() {
        document.getElementById('hearts-display').textContent = "‚ù§Ô∏è".repeat(lives);
        document.getElementById('btn-slow').textContent = `‚è≥ Slow (${items.slow})`;
        document.getElementById('btn-double').textContent = `‚≠ê x2 (${items.double})`;
        document.getElementById('btn-slow').disabled = items.slow <= 0;
        document.getElementById('btn-double').disabled = items.double <= 0;
    }

    function startGame(mode) {
      difficulty = mode; currentScore = 0; currentQ = 0; combo = 0; correctCount = 0; lives = 3; items = {slow: 1, double: 1};
      timeLimit = (mode === 'easy') ? 10 : (mode === 'medium' ? 18 : 35);
      updateHUD();
      changeScreen('game');
      nextQuestion();
    }

    function nextQuestion() {
      if (currentQ >= 20 || lives <= 0) { endGame(); return; }
      currentQ++;
      document.getElementById('qNum').textContent = `QUEST: ${currentQ}/20`;
      document.getElementById('answerInput').value = '';
      document.getElementById('answerInput').focus();
      document.getElementById('bonus-label').style.opacity = '0';
      
      const card = document.getElementById('gameCard');
      if(combo >= 5) card.classList.add('streak-aura-rgb');
      else card.classList.remove('streak-aura-rgb');

      // Ghost Mode Logic
      const ghost = document.getElementById('ghost-marker');
      if(bestTimes[difficulty]) {
        ghost.style.display = 'block';
        ghost.style.left = (100 - (bestTimes[difficulty] / timeLimit * 100)) + "%";
      } else {
        ghost.style.display = 'none';
      }

      if(difficulty === 'hard') generateHardQuestion();
      else if(difficulty === 'medium') generateMediumQuestion();
      else {
        let a = rand(1, 30), b = rand(1, 30);
        let op = ['+', '-'][rand(0, 1)];
        if (op === '-') { if (a < b) [a, b] = [b, a]; correctAns = a - b; }
        else { correctAns = a + b; }
        document.getElementById('questionText').innerHTML = `${a} ${op} ${b}`;
      }
      startTime = Date.now();
      startTimer();
    }

    function generateMediumQuestion() {
      let type = rand(1, 6); let qText = "";
      switch(type) {
        case 1: let a1 = rand(-25, 25), b1 = rand(-25, 25); qText = `${a1 < 0 ? '('+a1+')' : a1} + ${b1 < 0 ? '('+b1+')' : b1}`; correctAns = a1 + b1; break;
        case 2: let a2 = rand(-20, 20), b2 = rand(-20, 20); qText = `${a2 < 0 ? '('+a2+')' : a2} - ${b2 < 0 ? '('+b2+')' : b2}`; correctAns = a2 - b2; break;
        case 3: let c = rand(2, 12), d = rand(-11, 11); if (d === 0) d = 1; qText = `${c} √ó ${d < 0 ? '('+d+')' : d}`; correctAns = c * d; break;
        case 4: let x4 = rand(2, 15), coeff4 = rand(2, 6); qText = `‡∏´‡∏≤ x: ${coeff4}x = ${coeff4*x4}`; correctAns = x4; break;
        case 5: let base5 = rand(11, 20); qText = `${base5}<sup>2</sup> = ?`; correctAns = base5 * base5; break;
        case 6: let ans6 = rand(2, 15), div6 = rand(2, 9); qText = `${ans6*div6} √∑ ${div6} = ?`; correctAns = ans6; break;
      }
      document.getElementById('questionText').innerHTML = qText;
    }

    function generateHardQuestion() {
      let type = rand(1, 8); let qText = "";
      switch(type) {
        case 1: let x1 = rand(1, 15), a1 = rand(2, 8), b1 = rand(-15, 15); qText = `‡∏´‡∏≤ x: ${a1}x ${b1 >= 0 ? '+ ' + b1 : '- ' + Math.abs(b1)} = ${(a1*x1)+b1}`; correctAns = x1; break;
        case 2: let b2 = rand(2, 5), p2 = rand(3, 4); qText = `${b2}<sup>${p2}</sup> = ?`; correctAns = Math.pow(b2, p2); break;
        case 3: const tri = [{q:'sin 30¬∞', a:0.5}, {q:'cos 60¬∞', a:0.5}, {q:'tan 45¬∞', a:1}]; let p = tri[rand(0, 2)]; qText = `${p.q} = ?`; correctAns = p.a; break;
        case 4: let r = rand(13, 25); qText = `‚àö${r*r} = ?`; correctAns = r; break;
        case 5: let lb = [2, 3, 5, 10][rand(0,3)], ex = rand(2, 4); qText = `log<sub>${lb}</sub> ${Math.pow(lb,ex)} = ?`; correctAns = ex; break;
        case 6: let n6 = rand(-50, -10), m6 = rand(5, 20); qText = `|${n6}| - ${m6} = ?`; correctAns = Math.abs(n6) - m6; break;
        case 7: qText = `2<sup>-1</sup> = ? (‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°)`; correctAns = 0.5; break;
        case 8: let f = rand(3, 5), fr = 1; for(let i=1; i<=f; i++) fr*=i; qText = `${f}! = ?`; correctAns = fr; break;
      }
      document.getElementById('questionText').innerHTML = qText;
    }

    function rand(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

    function startTimer() {
      clearInterval(timer);
      const bar = document.getElementById('timer-fill');
      let effectiveTime = activeSlow ? timeLimit * 1.5 : timeLimit;
      activeSlow = false;
      bar.style.transition = 'none'; bar.style.width = '100%';
      bar.classList.remove('timer-danger');
      setTimeout(() => { 
        bar.style.transition = `width ${effectiveTime}s linear`; 
        bar.style.width = '0%'; 
      }, 50);
      let t = effectiveTime;
      timer = setInterval(() => { 
        t--; 
        if(t <= 3) bar.classList.add('timer-danger');
        if(t <= 0) { checkAnswer(); }
      }, 1000);
    }

    function checkAnswer() {
      const val = parseFloat(document.getElementById('answerInput').value);
      processResult(val === correctAns);
    }

    function processResult(isCorrect) {
      clearInterval(timer);
      const badge = document.getElementById('comboBadge');
      const card = document.getElementById('gameCard');
      const timeUsed = (Date.now() - startTime) / 1000;

      if (isCorrect) {
        // Update Ghost record
        if(!bestTimes[difficulty] || timeUsed < bestTimes[difficulty]) {
          bestTimes[difficulty] = timeUsed;
          localStorage.setItem('mathBestTimes', JSON.stringify(bestTimes));
        }

        correctCount++; combo++;
        let mult = 1 + (Math.min(combo, 15) * 0.1);
        let bonus = timeUsed < 4 ? 10 : 0;
        if(bonus > 0) document.getElementById('bonus-label').style.opacity = '1';
        let gained = Math.round(((difficulty === 'easy' ? 10 : (difficulty === 'medium' ? 15 : 25)) + bonus) * mult);
        if(activeDouble) { gained *= 2; activeDouble = false; }
        currentScore += gained;
        badge.textContent = `COMBO x${mult.toFixed(1)} üî•`;
        playSfx(400 + (combo * 60), 'triangle');
      } else {
        lives--; combo = 0; currentScore = Math.max(0, currentScore - 10);
        updateHUD();
        badge.textContent = `COMBO x1.0`;
        card.classList.add('shake');
        setTimeout(() => card.classList.remove('shake'), 300);
        playSfx(100, 'sawtooth', 0.4);
      }
      document.getElementById('score').textContent = currentScore;
      if(lives > 0) setTimeout(nextQuestion, 500);
      else endGame();
    }

    function endGame() {
      saveRank(currentScore);
      displayRank('rankTable');
      
      // Calculate Mockup Global Rank
      let percent = Math.min(99, Math.floor((currentScore / 2500) * 100));
      if(currentScore > 2000) percent = 99;
      else if(currentScore < 100) percent = rand(5, 15);
      document.getElementById('globalRankText').textContent = `‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Å‡πà‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ${percent}% ‡∏Ç‡∏≠‡∏á‡πÇ‡∏•‡∏Å üåè`;

      document.getElementById('finalScore').textContent = currentScore;
      document.getElementById('statsSummary').innerHTML = `‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ${correctCount}/20 ‡∏Ç‡πâ‡∏≠ | ‡∏£‡∏∞‡∏î‡∏±‡∏ö: ${difficulty.toUpperCase()}`;
      let badgeText = currentScore > 1000 ? "Math God ‚ö°" : (currentScore > 500 ? "Math Warrior" : "Novice");
      document.getElementById('badge-ui').textContent = badgeText;
      document.getElementById('congratsText').textContent = (lives <= 0) ? "GAME OVER!" : "MISSION COMPLETE!";
      document.getElementById('congratsText').style.color = (lives <= 0) ? "var(--danger)" : "var(--neon-green)";
      changeScreen('result');
      animateFireworks();
      playSfx(600, 'sine');
    }

    // --- [‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏ä‡∏£‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ---
    function shareAchievement() {
      const canvas = document.createElement('canvas');
      canvas.width = 600; canvas.height = 400;
      const ctx = canvas.getContext('2d');

      // BG
      const grad = ctx.createLinearGradient(0, 0, 600, 400);
      grad.addColorStop(0, '#1e1b4b'); grad.addColorStop(1, '#0f172a');
      ctx.fillStyle = grad; ctx.fillRect(0, 0, 600, 400);
      
      // Decor
      ctx.strokeStyle = '#6c5ce7'; ctx.lineWidth = 10; ctx.strokeRect(20, 20, 560, 360);
      
      // Text
      ctx.fillStyle = '#00ff88'; ctx.font = 'bold 30px Kanit'; ctx.fillText('MATHLETICS ACHIEVED!', 150, 80);
      ctx.fillStyle = 'white'; ctx.font = 'bold 80px Fredoka One'; ctx.fillText(currentScore, 200, 180);
      ctx.font = '30px Kanit'; ctx.fillText('SCORE', 240, 220);
      
      ctx.fillStyle = '#ff9f43'; ctx.font = 'bold 25px Kanit'; 
      ctx.fillText(document.getElementById('badge-ui').textContent, 210, 280);
      
      ctx.fillStyle = '#94a3b8'; ctx.font = '18px Kanit';
      ctx.fillText(document.getElementById('globalRankText').textContent, 170, 330);

      // Download
      const link = document.createElement('a');
      link.download = 'mathletics-score.png';
      link.href = canvas.toDataURL();
      link.click();
    }

    function saveRank(score) {
      let ranks = JSON.parse(localStorage.getItem('mathRanks') || "[]");
      ranks.push({score: score, date: new Date().toLocaleDateString()});
      ranks.sort((a, b) => b.score - a.score);
      localStorage.setItem('mathRanks', JSON.stringify(ranks.slice(0, 5)));
    }

    function displayRank(tableId) {
      let ranks = JSON.parse(localStorage.getItem('mathRanks') || "[]");
      let html = ranks.map((r, i) => `<tr><td>${i === 0 ? 'ü•á' : i+1}</td><td>${r.score} ‡πÅ‡∏ï‡πâ‡∏°</td><td>${r.date}</td></tr>`).join('');
      document.getElementById(tableId).innerHTML = html || "<tr><td colspan='3'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</td></tr>";
    }

    document.getElementById('answerInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') checkAnswer(); });
  </script>
</body>
</html>
