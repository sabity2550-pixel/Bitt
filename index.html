<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <title>Mathletics - Fun Math Game</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&family=Fredoka+One&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #a29bfe;
      --primary-dark: #6c5ce7;
      --bg-color: #f8f7ff;
      --card-bg: #ffffff;
      --success: #00b894;
      --danger: #ff7675;
      --gold: #f1c40f;
    }

    body {
      font-family: 'Kanit', sans-serif;
      margin: 0; background: var(--bg-color);
      display: flex; align-items: center; justify-content: center;
      height: 100vh; overflow: hidden; touch-action: manipulation;
    }

    .logo-text {
      font-family: 'Fredoka One', cursive;
      font-size: 3.5rem;
      letter-spacing: 2px;
      margin-bottom: 10px;
      display: inline-block;
    }
    .logo-text span:nth-child(1) { color: #ed7d7d; }
    .logo-text span:nth-child(2) { color: #f9b872; }
    .logo-text span:nth-child(3) { color: #ffca85; }
    .logo-text span:nth-child(4) { color: #ffe68d; }
    .logo-text span:nth-child(5) { color: #a8e6cf; }
    .logo-text span:nth-child(6) { color: #92d5e6; }
    .logo-text span:nth-child(7) { color: #a29bfe; }
    .logo-text span:nth-child(8) { color: #c3e0a0; }
    .logo-text span:nth-child(9) { color: #ffd372; }
    .logo-text span:nth-child(10) { color: #f9b872; }

    #music-control {
      position: fixed; top: 20px; right: 20px; z-index: 1000;
      background: white; border: 2px solid var(--primary);
      width: 45px; height: 45px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      font-size: 1.2rem; transition: 0.2s;
    }

    .screen {
      position: absolute; width: 100%; max-width: 480px;
      padding: 20px; box-sizing: border-box; text-align: center;
      transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .hidden { display: none !important; opacity: 0; transform: scale(0.9); }

    .card {
      background: var(--card-bg); padding: 30px 25px;
      border-radius: 35px; box-shadow: 0 20px 40px rgba(108, 92, 231, 0.1);
      border-bottom: 8px solid #efecfd;
    }

    button {
      background: var(--primary); color: white; border: none;
      padding: 18px 25px; border-radius: 22px; font-size: 1.1rem;
      font-weight: 600; cursor: pointer; transition: 0.2s;
      box-shadow: 0 6px 0 #8c85e6; width: 100%; font-family: 'Kanit';
      margin-bottom: 10px;
    }
    button.secondary { background: #b2bec3; box-shadow: 0 6px 0 #95a5a6; }
    button.rank-btn { background: #8e44ad; box-shadow: 0 6px 0 #703688; }
    button:active { transform: translateY(3px); box-shadow: 0 2px 0 #8c85e6; }

    .info-box { 
      text-align: left; 
      background: #fdfbff; 
      padding: 20px; 
      border-radius: 25px; 
      margin-bottom: 20px; 
      border: 1px solid #f0edff; 
      font-size: 1.05rem; 
      line-height: 1.6;
      max-height: 300px; 
      overflow-y: auto;
    }
    
    input[type="text"] {
      width: 100%; padding: 18px; font-size: 2.2rem;
      border: 4px solid #efecfd; border-radius: 25px;
      text-align: center; color: var(--primary-dark); font-weight: 600;
      background: #fdfbff; outline: none; box-sizing: border-box;
    }

    .timer-bar { width: 100%; height: 12px; background: #eee; border-radius: 10px; overflow: hidden; margin-bottom: 15px; }
    #timer-fill { height: 100%; background: var(--primary); width: 100%; }
    #bonus-label { color: var(--success); font-weight: bold; opacity: 0; height: 20px; }
    .combo-badge { display: inline-block; padding: 5px 15px; border-radius: 15px; background: #eee; color: #777; font-size: 0.9rem; margin-top: 10px; }
    .combo-active { background: var(--primary-dark); color: white; transform: scale(1.1); }

    .rank-table { width: 100%; margin-top: 15px; border-collapse: collapse; background: #fdfbff; border-radius: 15px; overflow: hidden; }
    .rank-table tr { border-bottom: 1px solid #f0edff; }
    .rank-table td { padding: 12px; font-size: 1rem; }
    .top-rank { color: var(--gold); font-weight: bold; background: #fffdf0; }
    .shake-screen { animation: screenShake 0.4s; }
    @keyframes screenShake {
      0%, 100% { transform: translate(0, 0); }
      25% { transform: translate(-5px, 5px); }
      50% { transform: translate(5px, -5px); }
      75% { transform: translate(-5px, -5px); }
    }
  </style>
</head>
<body id="mainBody">

  <div id="music-control" onclick="toggleMusic()">üîä</div>

  <div id="intro" class="screen">
    <div class="card">
      <div class="logo-text">
        <span>M</span><span>A</span><span>T</span><span>H</span><span>L</span><span>E</span><span>T</span><span>I</span><span>C</span><span>S</span>
      </div>
      <p style="margin-top:0; color:#636e72;">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡πÇ‡∏•‡∏Å‡πÅ‡∏´‡πà‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç</p>
      <button onclick="initAudio(); changeScreen('mathTips1')">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ ‚û°Ô∏è</button>
      <button class="rank-btn" onclick="viewRanks()">üèÜ ‡∏î‡∏π‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö Rank ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
    </div>
  </div>

  <div id="rankView" class="screen hidden">
    <div class="card">
      <div style="font-size: 3rem;">üèÜ</div>
      <h2 style="color:var(--primary-dark)">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
      <table class="rank-table" id="viewRankTable"></table>
      <div style="margin-top: 20px;">
        <button class="secondary" onclick="changeScreen('intro')">üîô ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
      </div>
    </div>
  </div>

  <div id="mathTips1" class="screen hidden">
    <div class="card">
      <h2>üìñ ‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏•‡πà‡∏ô & ‡πÇ‡∏ö‡∏ô‡∏±‡∏™</h2>
      <div class="info-box">
        ‚Ä¢ ‡∏ï‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÑ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö <b>‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß</b><br>
        ‚Ä¢ ‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏∞‡∏™‡∏° <b>Combo</b> ‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô<br>
        ‚Ä¢ ‡∏¢‡∏¥‡πà‡∏á‡πÇ‡∏´‡∏°‡∏î‡∏¢‡∏≤‡∏Å ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏à‡∏∞‡∏¢‡∏¥‡πà‡∏á‡∏™‡∏π‡∏á!<br>
        ‚Ä¢ ‡∏î‡∏ô‡∏ï‡∏£‡∏µ‡πÄ‡∏ö‡∏≤‡πÜ ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ò‡∏¥‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô
      </div>
      <div style="display:flex; gap:10px;">
        <button class="secondary" onclick="changeScreen('intro')">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        <button onclick="changeScreen('mathGuide')">‡∏ï‡πà‡∏≠‡πÑ‡∏õ üí°</button>
      </div>
    </div>
  </div>

  <div id="mathGuide" class="screen hidden">
    <div class="card">
      <h2 style="color:var(--primary-dark)">üí° ‡πÄ‡∏Å‡∏£‡πá‡∏î‡∏ô‡πà‡∏≤‡∏£‡∏π‡πâ‡∏™‡∏π‡πà‡∏ä‡∏±‡∏¢‡∏ä‡∏ô‡∏∞</h2>
      <div class="info-box">
        <b style="font-size: 1.2rem; color: #00b894;">üü¢ ‡πÇ‡∏´‡∏°‡∏î‡∏á‡πà‡∏≤‡∏¢:</b><br>
        ‚Ä¢ ‡πÄ‡∏•‡∏Ç‡∏≠‡∏∞‡πÑ‡∏£‡∏Ñ‡∏π‡∏ì 0 ‡πÑ‡∏î‡πâ 0 ‡πÄ‡∏™‡∏°‡∏≠!<br>
        ‚Ä¢ ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏ö‡∏ß‡∏Å 9: ‡πÉ‡∏´‡πâ +10 ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏±‡∏Å‡∏≠‡∏≠‡∏Å 1 ‡∏à‡∏∞‡πÑ‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏Å<br><br>
        
        <b style="font-size: 1.2rem; color: #8e44ad;">üü° ‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á:</b><br>
        ‚Ä¢ ‡∏Å‡∏é‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢: ‡∏•‡∏ö ‡πÄ‡∏à‡∏≠‡∏Å‡∏±‡∏ö ‡∏•‡∏ö ‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô <b>‡∏ö‡∏ß‡∏Å</b>!<br>
        ‚Ä¢ ‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≤‡∏á‡∏™‡∏°‡∏Å‡∏≤‡∏£: ‡∏¢‡πâ‡∏≤‡∏¢‡∏à‡∏≤‡∏Å + ‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô -, ‡∏¢‡πâ‡∏≤‡∏¢‡∏à‡∏≤‡∏Å √ó ‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô √∑<br>
        ‚Ä¢ ‡πÄ‡∏•‡∏Ç‡∏¢‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô: 11¬≤=121, 12¬≤=144, 15¬≤=225<br><br>
        
        <b style="font-size: 1.2rem; color: var(--primary-dark);">üî¥ ‡πÇ‡∏´‡∏°‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏¢‡∏≤‡∏Å:</b><br>
        ‚Ä¢ <b>‡∏ï‡∏£‡∏µ‡πÇ‡∏Å‡∏ì:</b> ‡πÉ‡∏ä‡πâ‡∏Å‡∏é‡∏°‡∏∑‡∏≠‡∏ã‡πâ‡∏≤‡∏¢‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≥ sin(‡∏ã‡πâ‡∏≤‡∏¢) cos(‡∏Ç‡∏ß‡∏≤)<br>
        ‚Ä¢ <b>Logarithm:</b> log‚Çê a = 1 ‡πÅ‡∏•‡∏∞ log‚Çê 1 = 0 ‡πÄ‡∏™‡∏°‡∏≠<br>
        ‚Ä¢ <b>‡πÄ‡∏•‡∏Ç‡∏¢‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏•‡∏ö:</b> a‚Åª‚Åø ‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏®‡∏©‡∏™‡πà‡∏ß‡∏ô ‡πÄ‡∏ä‡πà‡∏ô 2‚Åª¬π = 1/2
      </div>
      <div style="display:flex; gap:10px;">
        <button class="secondary" onclick="changeScreen('mathTips1')">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        <button onclick="changeScreen('mode')">‡πÑ‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î üéÆ</button>
      </div>
    </div>
  </div>

  <div id="mode" class="screen hidden">
    <div class="card">
      <h2 style="color:var(--primary-dark)">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å</h2>
      <div style="display:flex; flex-direction:column; gap:10px;">
        <button onclick="startGame('easy')">üü¢ ‡∏á‡πà‡∏≤‡∏¢ (‡∏õ‡∏£‡∏∞‡∏ñ‡∏°)</button>
        <button onclick="startGame('medium')" style="background:#8e44ad; box-shadow: 0 6px 0 #703688;">üü° ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (‡∏°.‡∏ï‡πâ‡∏ô üè´)</button>
        <button onclick="startGame('hard')" style="background:var(--primary-dark); box-shadow: 0 6px 0 #4834d4;">üî¥ ‡∏¢‡∏≤‡∏Å (‡∏°.‡∏õ‡∏•‡∏≤‡∏¢ üéì)</button>
        <button class="secondary" onclick="changeScreen('mathGuide')">üîô ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
      </div>
    </div>
  </div>

  <div id="game" class="screen hidden">
    <div class="card">
      <div class="timer-bar"><div id="timer-fill"></div></div>
      <div style="display:flex; justify-content:space-between; font-weight:bold; color:var(--primary-dark);">
        <span id="qNum">‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 1/20</span>
        <span>‚≠ê <span id="score">0</span></span>
      </div>
      <div id="questionText" style="font-size:2.8rem; font-weight:600; margin:20px 0; min-height: 80px; display: flex; align-items: center; justify-content: center;">?</div>
      <input type="text" id="answerInput" inputmode="numeric" placeholder="?" autocomplete="off">
      <div id="bonus-label">‡πÇ‡∏ö‡∏ô‡∏±‡∏™!</div>
      <div id="comboBadge" class="combo-badge">COMBO x1.0</div>
      <button onclick="checkAnswer()">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
    </div>
  </div>

  <div id="result" class="screen hidden">
    <div class="card">
      <h1>‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å! üéâ</h1>
      <p>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: <b id="finalScore" style="color:var(--primary-dark); font-size:2rem;">0</b></p>
      <table class="rank-table" id="rankTable"></table>
      <div id="statsSummary" style="margin:15px 0; font-size: 0.85rem;"></div>
      <button onclick="location.reload()" style="background:var(--primary-dark);">üè† ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
    </div>
  </div>

  <script>
    let audioCtx, isMuted = false;
    let currentScore = 0, currentQ = 0, correctAns = 0, timer, difficulty = 'easy';
    let combo = 0, correctCount = 0, startTime, timeLimit = 12;

    function initAudio() {
      if (audioCtx) return;
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      playRelaxingMusic();
    }

    function playRelaxingMusic() {
      const notes = [261.63, 329.63, 392.00, 440.00, 523.25]; 
      let lastNote = -1;
      function playNextNote() {
        if (isMuted) { setTimeout(playNextNote, 3000); return; }
        let idx;
        do { idx = Math.floor(Math.random() * notes.length); } while (idx === lastNote);
        lastNote = idx;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(notes[idx], audioCtx.currentTime);
        const vol = 0.02; 
        gain.gain.setValueAtTime(0, audioCtx.currentTime);
        gain.gain.linearRampToValueAtTime(vol, audioCtx.currentTime + 1);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 5);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 5.5);
        setTimeout(playNextNote, 2500 + Math.random() * 2000);
      }
      playNextNote();
    }

    function toggleMusic() {
      isMuted = !isMuted;
      document.getElementById('music-control').textContent = isMuted ? '‚ùå' : 'üîä';
    }

    function playSfx(freq, type='sine') {
      if (isMuted || !audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
      gain.gain.setValueAtTime(0.03, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.start(); osc.stop(audioCtx.currentTime + 0.2);
    }

    function changeScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
    }

    function viewRanks() { displayRank('viewRankTable'); changeScreen('rankView'); }

    function startGame(mode) {
      difficulty = mode; currentScore = 0; currentQ = 0; combo = 0; correctCount = 0;
      timeLimit = (mode === 'easy') ? 12 : (mode === 'medium' ? 20 : 40);
      changeScreen('game');
      nextQuestion();
    }

    function nextQuestion() {
      if (currentQ >= 20) { endGame(); return; }
      currentQ++;
      document.getElementById('qNum').textContent = `‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${currentQ}/20`;
      document.getElementById('answerInput').value = '';
      document.getElementById('answerInput').focus();
      document.getElementById('bonus-label').style.opacity = '0';
      
      if(difficulty === 'hard') {
        generateHardQuestion();
      } else if(difficulty === 'medium') {
        generateMediumQuestion();
      } else {
        let a = rand(1, 30), b = rand(1, 30);
        let ops = ['+', '-'];
        let op = ops[rand(0, 1)];
        if (op === '-') {
            if (a < b) [a, b] = [b, a];
            correctAns = a - b;
        } else {
            correctAns = a + b;
        }
        document.getElementById('questionText').innerHTML = `${a} ${op} ${b}`;
      }
      
      startTime = Date.now();
      startTimer();
    }

    function generateMediumQuestion() {
      let type = rand(1, 6); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÇ‡∏à‡∏ó‡∏¢‡πå
      let qText = "";
      switch(type) {
        case 1: // ‡∏Å‡∏≤‡∏£‡∏ö‡∏ß‡∏Å‡πÄ‡∏•‡∏Ç‡∏ï‡∏¥‡∏î‡∏•‡∏ö
          let a1 = rand(-25, 25), b1 = rand(-25, 25);
          qText = `${a1 < 0 ? '('+a1+')' : a1} + ${b1 < 0 ? '('+b1+')' : b1}`; 
          correctAns = a1 + b1;
          break;
        case 2: // ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏•‡∏Ç‡∏ï‡∏¥‡∏î‡∏•‡∏ö
          let a2 = rand(-20, 20), b2 = rand(-20, 20);
          qText = `${a2 < 0 ? '('+a2+')' : a2} - ${b2 < 0 ? '('+b2+')' : b2}`; 
          correctAns = a2 - b2;
          break;
        case 3: // ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏π‡∏ì‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô (‡∏£‡∏ß‡∏°‡∏ï‡∏¥‡∏î‡∏•‡∏ö)
          let c = rand(2, 12), d = rand(-11, 11);
          if (d === 0) d = 1;
          qText = `${c} √ó ${d < 0 ? '('+d+')' : d}`; 
          correctAns = c * d;
          break;
        case 4: // ‡∏™‡∏°‡∏Å‡∏≤‡∏£‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
          let x4 = rand(2, 15), coeff4 = rand(2, 6);
          let res4 = x4 * coeff4;
          qText = `‡∏´‡∏≤ x: ${coeff4}x = ${res4}`; 
          correctAns = x4;
          break;
        case 5: // ‡πÄ‡∏•‡∏Ç‡∏¢‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á 2 (11-20)
          let base5 = rand(11, 20);
          qText = `${base5}<sup>2</sup> = ?`; 
          correctAns = base5 * base5;
          break;
        case 6: // ‡∏´‡∏≤‡∏£‡∏•‡∏á‡∏ï‡∏±‡∏ß
          let ans6 = rand(2, 15), divisor6 = rand(2, 9);
          let dividend6 = ans6 * divisor6;
          qText = `${dividend6} √∑ ${divisor6} = ?`;
          correctAns = ans6;
          break;
      }
      document.getElementById('questionText').innerHTML = qText;
    }

    function generateHardQuestion() {
      let type = rand(1, 8); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô 8 ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö
      let qText = "";
      switch(type) {
        case 1: // ‡∏™‡∏°‡∏Å‡∏≤‡∏£ 2 ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô
          let x1 = rand(1, 15), a1 = rand(2, 8), b1 = rand(-15, 15);
          let res1 = (a1 * x1) + b1;
          qText = `‡∏´‡∏≤ x: ${a1}x ${b1 >= 0 ? '+ ' + b1 : '- ' + Math.abs(b1)} = ${res1}`; 
          correctAns = x1;
          break;
        case 2: // ‡πÄ‡∏•‡∏Ç‡∏¢‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á 3
          let base2 = rand(2, 6);
          let pwr2 = rand(3, 4);
          qText = `${base2}<sup>${pwr2}</sup> = ?`; 
          correctAns = Math.pow(base2, pwr2);
          break;
        case 3: // ‡∏ï‡∏£‡∏µ‡πÇ‡∏Å‡∏ì‡∏°‡∏¥‡∏ï‡∏¥ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏∏‡∏°)
          const tri = [
            {q:'sin 30¬∞', a:0.5}, {q:'cos 60¬∞', a:0.5}, {q:'sin 90¬∞', a:1}, 
            {q:'tan 45¬∞', a:1}, {q:'cos 0¬∞', a:1}, {q:'sin 0¬∞', a:0},
            {q:'cos 30¬∞', a:0.9} // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢
          ];
          let pick = tri[rand(0, tri.length - 1)];
          qText = `${pick.q} = ? (‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° 1 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)`; 
          correctAns = pick.a;
          break;
        case 4: // ‡∏£‡∏π‡∏ó‡∏ä‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á
          let rootBase = rand(13, 25);
          qText = `‚àö${rootBase * rootBase} = ?`; 
          correctAns = rootBase;
          break;
        case 5: // Logarithm (‡∏ê‡∏≤‡∏ô‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏°‡∏≤)
          let lBases = [2, 3, 5, 10];
          let lBase = lBases[rand(0, 3)];
          let exp = rand(2, 4);
          let val = Math.pow(lBase, exp);
          qText = `log<sub>${lBase}</sub> ${val} = ?`; 
          correctAns = exp;
          break;
        case 6: // ‡∏Ñ‡πà‡∏≤‡∏™‡∏±‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
          let n6 = rand(-50, -10), m6 = rand(5, 20);
          qText = `|${n6}| - ${m6} = ?`;
          correctAns = Math.abs(n6) - m6;
          break;
        case 7: // ‡πÄ‡∏•‡∏Ç‡∏¢‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏•‡∏ö
          let b7 = 2, p7 = -1;
          let r7 = rand(1, 3);
          if (r7 === 1) { qText = `2<sup>-1</sup> = ? (‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°)`; correctAns = 0.5; }
          else if (r7 === 2) { qText = `5<sup>-1</sup> = ? (‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°)`; correctAns = 0.2; }
          else { qText = `4<sup>-1</sup> = ? (‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°)`; correctAns = 0.25; }
          break;
        case 8: // ‡πÅ‡∏ü‡∏Å‡∏ó‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
          let fNum = rand(3, 5);
          qText = `${fNum}! = ?`;
          let fRes = 1; for(let i=1; i<=fNum; i++) fRes *= i;
          correctAns = fRes;
          break;
      }
      document.getElementById('questionText').innerHTML = qText;
    }

    function rand(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

    function startTimer() {
      clearInterval(timer);
      const bar = document.getElementById('timer-fill');
      bar.style.transition = 'none'; bar.style.width = '100%';
      setTimeout(() => { bar.style.transition = `width ${timeLimit}s linear`; bar.style.width = '0%'; }, 50);
      let t = timeLimit;
      timer = setInterval(() => { t--; if(t <= 0) checkAnswer(); }, 1000);
    }

    function checkAnswer() {
      const val = parseFloat(document.getElementById('answerInput').value);
      processResult(val === correctAns);
    }

    function processResult(isCorrect) {
      clearInterval(timer);
      const badge = document.getElementById('comboBadge');
      if (isCorrect) {
        correctCount++; combo++;
        let mult = 1 + (Math.min(combo, 10) * 0.1);
        let bonusThreshold = (difficulty === 'hard' ? 10 : (difficulty === 'medium' ? 7 : 5));
        let bonus = (Date.now() - startTime) / 1000 < bonusThreshold ? 5 : 0;
        if(bonus > 0) document.getElementById('bonus-label').style.opacity = '1';
        currentScore += Math.round(((difficulty === 'easy' ? 10 : (difficulty === 'medium' ? 15 : 20)) + bonus) * mult);
        badge.textContent = `COMBO x${mult.toFixed(1)} üî•`;
        badge.classList.add('combo-active');
        playSfx(500 + (combo * 50));
      } else {
        combo = 0; currentScore = Math.max(0, currentScore - 5);
        badge.textContent = `COMBO x1.0`;
        badge.classList.remove('combo-active');
        document.getElementById('mainBody').classList.add('shake-screen');
        setTimeout(() => document.getElementById('mainBody').classList.remove('shake-screen'), 400);
        playSfx(150, 'sawtooth');
      }
      document.getElementById('score').textContent = currentScore;
      setTimeout(nextQuestion, 600);
    }

    function endGame() {
      saveRank(currentScore);
      displayRank('rankTable');
      document.getElementById('finalScore').textContent = currentScore;
      document.getElementById('statsSummary').innerHTML = `‚úÖ ‡∏ñ‡∏π‡∏Å ${correctCount}/20 | ‡πÇ‡∏´‡∏°‡∏î: ${difficulty === 'easy' ? '‡∏á‡πà‡∏≤‡∏¢' : (difficulty === 'medium' ? '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á' : '‡∏¢‡∏≤‡∏Å')}`;
      changeScreen('result');
    }

    function saveRank(score) {
      let ranks = JSON.parse(localStorage.getItem('mathRanks') || "[]");
      ranks.push({score: score, date: new Date().toLocaleDateString()});
      ranks.sort((a, b) => b.score - a.score);
      ranks = ranks.slice(0, 5);
      localStorage.setItem('mathRanks', JSON.stringify(ranks));
    }

    function displayRank(tableId) {
      let ranks = JSON.parse(localStorage.getItem('mathRanks') || "[]");
      let html = ranks.map((r, i) => `
        <tr class="${i === 0 ? 'top-rank' : ''}">
          <td>${i === 0 ? 'ü•á' : i+1}</td>
          <td>${r.score} ‡πÅ‡∏ï‡πâ‡∏°</td>
          <td style="font-size:0.7rem; color:#aaa;">${r.date}</td>
        </tr>
      `).join('');
      document.getElementById(tableId).innerHTML = html || "<tr><td colspan='3'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>";
    }

    document.getElementById('answerInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') checkAnswer(); });
  </script>
</body>
</html>
